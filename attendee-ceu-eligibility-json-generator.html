<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Conference Data Generators</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:20px;margin-bottom:30px}
    h1{font-size:20px;margin:0 0 12px}
    label{font-weight:600;font-size:13px}
    input[type="file"],input[type="text"]{padding:8px;border:1px solid #ddd;border-radius:8px}
    .controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn{padding:9px 12px;border-radius:8px;border:1px solid #ddd;cursor:pointer}
    .btn.primary{background:#1f6feb;color:#fff;border-color:#1f6feb}
    textarea{width:100%;height:300px;margin-top:10px;font-family:monospace;white-space:pre;border:1px solid #ddd;border-radius:8px;padding:10px}
    .errors{white-space:pre-wrap;color:#b91c1c;font-weight:600;margin-top:8px}
    .indicator{font-size:12px;color:green;opacity:0;transition:opacity .15s}
    .indicator.show{opacity:1}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- ============ CEU ELIGIBILITY ============ -->
  <div class="card">
    <h1>CEU Eligibility Generator</h1>
    <label>Registration CSV</label><br>
    <input id="regFile" type="file" accept=".csv">
    <div class="controls">
      <button id="processCEUBtn" class="btn primary">Generate CEU JSON</button>
      <button id="publishCEUBtn" class="btn">Publish CEU JSON</button>
      <span id="publishCEUInd" class="indicator">Published!</span>
    </div>
    <textarea id="ceuOut" readonly></textarea>
    <div id="ceuErrs" class="errors"></div>
  </div>

  <!-- ============ SESSION/SPEAKER INDEX ============ -->
  <div class="card">
    <h1>Session + Speaker Index Generator</h1>
    <div class="row">
      <div><label>Session CSV</label><br><input id="sessionFile" type="file" accept=".csv"></div>
      <div><label>Speaker CSV</label><br><input id="speakerFile" type="file" accept=".csv"></div>
      <div><label>Registration CSV</label><br><input id="regFile2" type="file" accept=".csv"></div>
      <div><label>Timezone offset</label><br><input id="tzOffset" type="text" value="-06:00"></div>
    </div>
    <div class="controls">
      <button id="processSessBtn" class="btn primary">Generate Sessions JSON</button>
      <button id="publishSessBtn" class="btn">Publish Sessions JSON</button>
      <span id="publishSessInd" class="indicator">Published!</span>
    </div>
    <textarea id="sessOut"></textarea>
    <div id="sessErrs" class="errors"></div>
  </div>

</div>

<script>
/* ---------- Shared CSV helpers ---------- */
function parseCSVLine(line){const out=[];let cur='',inQ=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(inQ&&i+1<line.length&&line[i+1]==='"'){cur+='"';i++;}else{inQ=!inQ;}}else if(ch===','&&!inQ){out.push(cur);cur='';}else cur+=ch;}out.push(cur);return out;}
function splitIntoLogicalRows(text){const phys=String(text).split(/\r\n|\n/),rows=[];let buf='',q=0;for(const line of phys){if(buf===''){buf=line;q=(line.match(/"/g)||[]).length;}else{buf+='\n'+line;q+=(line.match(/"/g)||[]).length;}if(q%2===0){rows.push(buf);buf='';q=0;}}if(buf.trim()!=='')rows.push(buf);return rows.filter(r=>r.trim()!=='');}
function cleanCell(v){if(v===undefined||v===null) return '';v=String(v).trim();if(v.startsWith('"')&&v.endsWith('"')&&v.length>=2)v=v.slice(1,-1).replace(/""/g,'"');return v;}
function normalizeHeader(h){return String(h||'').replace(/^\uFEFF/,'').toLowerCase().trim();}
function getDenverAsOf(){const fmt=new Intl.DateTimeFormat('en-US',{timeZone:'America/Denver',month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true,timeZoneName:'short'});return fmt.format(new Date());}

/* ---------- CEU Eligibility Generator ---------- */
const DEFAULT_ITER=30000,enc=new TextEncoder();
function bytesToB64(b){return btoa(String.fromCharCode(...new Uint8Array(b)));}
function b64ToBytes(b64){return Uint8Array.from(atob(b64),c=>c.charCodeAt(0));}
function normEmail(s){return (s||"").trim().toLowerCase();}
function randSaltB64(len=16){const a=new Uint8Array(len);crypto.getRandomValues(a);return bytesToB64(a);}
async function deriveHashB64(email,saltB64,iterations=DEFAULT_ITER){const key=await crypto.subtle.importKey("raw",enc.encode(email),{name:"PBKDF2"},false,["deriveBits"]);const bits=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:b64ToBytes(saltB64),iterations},key,256);return bytesToB64(new Uint8Array(bits));}

const $reg=document.getElementById('regFile'),$ceuOut=document.getElementById('ceuOut'),$ceuErrs=document.getElementById('ceuErrs'),$publishCEUInd=document.getElementById('publishCEUInd');let lastCEU=null;
function readFileAsText(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=e=>res(e.target.result);fr.onerror=e=>rej(e);fr.readAsText(file);});}

document.getElementById('processCEUBtn').addEventListener('click',async()=>{try{if(!$reg.files.length){$ceuErrs.textContent='ERROR: Select Registration CSV';return;}const regText=await readFileAsText($reg.files[0]);const regRows=splitIntoLogicalRows(regText);if(regRows.length<2){$ceuErrs.textContent='ERROR: Registration CSV empty';return;}const regHeaders=parseCSVLine(regRows[0]).map(h=>h.trim());const regNorm=regHeaders.map(normalizeHeader);const emailIdx=regNorm.indexOf('email address'),firstIdx=regNorm.indexOf('first name'),lastIdx=regNorm.indexOf('last name'),typeIdx=regNorm.indexOf('registration type');if(emailIdx===-1||firstIdx===-1||lastIdx===-1||typeIdx===-1){$ceuErrs.textContent='ERROR: Missing column';return;}const attendeesRaw=[];regRows.slice(1).forEach(r=>{const f=parseCSVLine(r);const email=cleanCell(f[emailIdx]);const first=cleanCell(f[firstIdx]);const last=cleanCell(f[lastIdx]);const regType=cleanCell(f[typeIdx]);const ceu=/ceu/i.test(regType)?'Yes':'No';if(email)attendeesRaw.push({name:`${first} ${last}`.trim(),email:normEmail(email),ceu});});const hashed=[];for(const r of attendeesRaw){const salt=randSaltB64();const hash=await deriveHashB64(r.email,salt,DEFAULT_ITER);hashed.push({name:r.name,salt,hash,ceu:r.ceu});}lastCEU={SESSIONS_AS_OF:getDenverAsOf(),PBKDF2_ITERATIONS:DEFAULT_ITER,ATTENDEE_INDEX:hashed};$ceuOut.value=JSON.stringify(lastCEU,null,2);$ceuErrs.textContent='';}catch(e){$ceuErrs.textContent='ERROR: '+e.message;}});

document.getElementById('publishCEUBtn').addEventListener('click',async()=>{if(!lastCEU){$ceuErrs.textContent='Generate first';return;}try{const res=await fetch('/api/update-gist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(lastCEU)});const result=await res.json();if(res.ok){$publishCEUInd.classList.add('show');setTimeout(()=>{$publishCEUInd.classList.remove('show')},1000);}else{$ceuErrs.textContent='Publish failed: '+(result.message||'Unknown');}}catch(e){$ceuErrs.textContent='Publish error: '+e.message;}});

/* ---------- Session/Speaker Index Generator ---------- */
const $session=document.getElementById('sessionFile'),$speaker=document.getElementById('speakerFile'),$reg2=document.getElementById('regFile2'),$tzOff=document.getElementById('tzOffset'),$sessOut=document.getElementById('sessOut'),$sessErrs=document.getElementById('sessErrs'),$publishSessInd=document.getElementById('publishSessInd');let lastSess=null;

document.getElementById('processSessBtn').addEventListener('click',async()=>{try{if(!$session.files.length||!$speaker.files.length||!$reg2.files.length){$sessErrs.textContent='ERROR: Need Session, Speaker, and Registration CSVs';return;}const [sessText,speakerText,regText]=await Promise.all([readFileAsText($session.files[0]),readFileAsText($speaker.files[0]),readFileAsText($reg2.files[0])]);const sessRows=splitIntoLogicalRows(sessText),spRows=splitIntoLogicalRows(speakerText),regRows=splitIntoLogicalRows(regText);if(sessRows.length<2||spRows.length<2||regRows.length<2){$sessErrs.textContent='ERROR: One CSV empty';return;}const regHeaders=parseCSVLine(regRows[0]).map(h=>h.trim()),regNorm=regHeaders.map(normalizeHeader),emailIdx=regNorm.indexOf('email address');const regEmails=new Set();regRows.slice(1).forEach(r=>{const f=parseCSVLine(r);const email=cleanCell(f[emailIdx]);if(email)regEmails.add(email.toLowerCase());});const sessHeaders=parseCSVLine(sessRows[0]).map(h=>h.trim()),sessNorm=sessHeaders.map(normalizeHeader);const sessions=sessRows.slice(1).map(row=>{const f=parseCSVLine(row),o={};sessNorm.forEach((h,i)=>o[h]=cleanCell(f[i]));return o;});const spHeaders=parseCSVLine(spRows[0]).map(h=>h.trim()),spNorm=spHeaders.map(normalizeHeader),speakersMap={};spRows.slice(1).forEach(r=>{const f=parseCSVLine(r),o={};spNorm.forEach((h,i)=>o[h]=cleanCell(f[i]));const sess=o['session code'],code=o['code'];if(sess&&code){(speakersMap[sess]||(speakersMap[sess]={}))[code]={name:`${o['first name']} ${o['last name']}`.trim(),email:o['email address']||''};}});const tz=$tzOff.value;const outObjs=sessions.map(row=>{const speakerCodes=(row['speaker code']||'').split(',').map(x=>x.trim()).filter(Boolean);const speakers=speakerCodes.map(code=>{const info=(speakersMap[row['session code']]||{})[code];if(!info)return null;return{name:info.name,email:info.email,registration:regEmails.has(info.email.toLowerCase())?'Yes':'No'};}).filter(Boolean);return{id:row['session id']||'',title:row['session name']||'',description:row['description']||'',date:row['session start date/time']||'',time:row['end date/time']||'',theme:row['category']||'',speakers};});lastSess={SESSIONS_AS_OF:getDenverAsOf(),sessions:outObjs};$sessOut.value=JSON.stringify(lastSess,null,2);$sessErrs.textContent='';}catch(e){$sessErrs.textContent='ERROR: '+e.message;}});

document.getElementById('publishSessBtn').addEventListener('click',async()=>{if(!lastSess){$sessErrs.textContent='Generate first';return;}try{const res=await fetch('/api/update-session-speaker-gist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(lastSess)});const result=await res.json();if(res.ok){$publishSessInd.classList.add('show');setTimeout(()=>{$publishSessInd.classList.remove('show')},1000);}else{$sessErrs.textContent='Publish failed: '+(result.message||'Unknown');}}catch(e){$sessErrs.textContent='Publish error: '+e.message;}});
</script>
</body>
</html>
