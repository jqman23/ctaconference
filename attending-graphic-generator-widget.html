<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Generate Graphic</title>
  <!-- Montserrat Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #162A53;
      --accent-color: #DDE6C0;
      --text-color: #000000; /* Black for all text except button */
      --border-radius: 4px;
    }

    /* Apply Montserrat and black text globally */
    body, p, select, button, textarea, div, .option-label {
      font-family: 'Montserrat', sans-serif;
      color: var(--text-color);
    }

    /* Paragraph styling */
    p {
      font-size: 16px;
      font-weight: 400;
      line-height: normal;
      margin-bottom: 12px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    #form-container {
      background: #ffffff;
      width: 100%;
      max-width: 700px;
      padding: 16px 24px;
    }

    .options-group {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 24px;
    }

    .option-card {
      display: flex;
      align-items: center;
      background: #ffffff;
      padding: 10px 14px;
      cursor: pointer;
    }

    .option-card input[type="radio"] {
      appearance: none;
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      margin-right: 10px;
      position: relative;
      cursor: pointer;
    }

    .option-card input[type="radio"]:checked {
      background: var(--primary-color);
    }

    .option-card input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 8px;
      height: 8px;
      background: #ffffff;
      border-radius: 50%;
    }

    .option-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 400;
      line-height: normal;
      flex: 1;
      background: #ffffff;
    }

    .option-label img {
      width: 36px;
      height: auto;
      border-radius: 0;
    }

    #custom-upload {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      padding-left: 28px;
    }

    #headshot-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #cccccc;
      font-size: 16px;
      line-height: normal;
    }

    #headshot-input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    #generate-btn {
      display: block;
      width: 100%;
      background: var(--accent-color);
      color: #000000; /* Button text stays black */
      border: none;
      padding: 10px 0;
      font-size: 16px;
      font-weight: 400;
      line-height: normal;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: none;
    }

    #generate-btn:hover {
      filter: brightness(0.9);
    }

    @media (max-width: 800px) {
      #form-container {
        max-width: 100%;
      }
      .options-group {
        grid-template-columns: repeat(2, 1fr);
      }
      #custom-upload {
        padding-left: 0;
      }
    }

    @media (max-width: 480px) {
      .options-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <!-- pdf-lib CDN -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
  <div id="form-container">
    <p>Select an image for your graphic:</p>
    <div class="options-group">
      <!-- Preset Option 1 -->
      <label class="option-card" for="preset1">
        <input type="radio" name="image-option" id="preset1" value="preset1" checked>
        <span class="option-label">
          <span>Use Preset Image 1</span>
          <img src="https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/d9763d9dc8b64ad5abc391fcf840bf33.png" alt="Preset 1">
        </span>
      </label>

      <!-- Preset Option 2 -->
      <label class="option-card" for="preset2">
        <input type="radio" name="image-option" id="preset2" value="preset2">
        <span class="option-label">
          <span>Use Preset Image 2</span>
          <img src="https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/a85ed9884bb142f8b4fb629685bf88be.png" alt="Preset 2">
        </span>
      </label>

      <!-- Preset Option 3 -->
      <label class="option-card" for="preset3">
        <input type="radio" name="image-option" id="preset3" value="preset3">
        <span class="option-label">
          <span>Use Preset Image 3</span>
          <img src="https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/fad70cb89efd4e3588d19a935de95096.png" alt="Preset 3">
        </span>
      </label>

      <!-- Preset Option 4 -->
      <label class="option-card" for="preset4">
        <input type="radio" name="image-option" id="preset4" value="preset4">
        <span class="option-label">
          <span>Use Preset Image 4</span>
          <img src="https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/76a1cdba0e554b798632e2dcb32d6914.png" alt="Preset 4">
        </span>
      </label>

      <!-- Preset Option 5 -->
      <label class="option-card" for="preset5">
        <input type="radio" name="image-option" id="preset5" value="preset5">
        <span class="option-label">
          <span>Use Preset Image 5</span>
          <img src="https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/795bccf392e04e5caf345b61ca28892e.png" alt="Preset 5">
        </span>
      </label>

      <!-- Custom Upload Option -->
      <label class="option-card" for="custom">
        <input type="radio" name="image-option" id="custom" value="custom">
        <span class="option-label">Upload your own image or headshot</span>
      </label>

      <!-- File input (disabled until custom is selected) -->
      <div id="custom-upload">
        <input type="file" id="headshot-input" accept="image/png, image/jpeg" disabled>
      </div>
    </div>
    <button id="generate-btn">Generate Graphic</button>
  </div>

  <script>
    (async () => {
      const { PDFDocument } = PDFLib;

      // URLs for template PNG and preset images
      const TEMPLATE_URL = 'https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/a492749233d84597b00bd0ee791f9baf.png';
      const OPTION1_URL = 'https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/d9763d9dc8b64ad5abc391fcf840bf33.png';
      const OPTION2_URL = 'https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/a85ed9884bb142f8b4fb629685bf88be.png';
      const OPTION3_URL = 'https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/fad70cb89efd4e3588d19a935de95096.png';
      const OPTION4_URL = 'https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/76a1cdba0e554b798632e2dcb32d6914.png';
      const OPTION5_URL = 'https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/795bccf392e04e5caf345b61ca28892e.png';

      // Utility: fetch an arrayBuffer from a URL
      async function fetchArrayBuffer(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Failed to fetch ${url}`);
        return await res.arrayBuffer();
      }

      // Enable/disable file input based on radio selection
      const preset1Radio = document.getElementById('preset1');
      const preset2Radio = document.getElementById('preset2');
      const preset3Radio = document.getElementById('preset3');
      const preset4Radio = document.getElementById('preset4');
      const preset5Radio = document.getElementById('preset5');
      const customRadio  = document.getElementById('custom');
      const fileInput    = document.getElementById('headshot-input');

      function updateFileInputState() {
        if (customRadio.checked) {
          fileInput.disabled = false;
        } else {
          fileInput.disabled = true;
          fileInput.value = '';
        }
      }

      // Initialize file input state
      updateFileInputState();

      preset1Radio.addEventListener('change', updateFileInputState);
      preset2Radio.addEventListener('change', updateFileInputState);
      preset3Radio.addEventListener('change', updateFileInputState);
      preset4Radio.addEventListener('change', updateFileInputState);
      preset5Radio.addEventListener('change', updateFileInputState);
      customRadio.addEventListener('change', updateFileInputState);

      async function getImageDimensionsFromBytes(bytes) {
        return new Promise((resolve, reject) => {
          const blob = new Blob([bytes]);
          const url = URL.createObjectURL(blob);
          const img = new window.Image();
          img.onload = () => {
            resolve({ width: img.naturalWidth, height: img.naturalHeight });
            URL.revokeObjectURL(url);
          };
          img.onerror = reject;
          img.src = url;
        });
      }

      document.getElementById('generate-btn').addEventListener('click', async () => {
        let overlayBytes;
        try {
          if (preset1Radio.checked) {
            overlayBytes = await fetchArrayBuffer(OPTION1_URL);
          } else if (preset2Radio.checked) {
            overlayBytes = await fetchArrayBuffer(OPTION2_URL);
          } else if (preset3Radio.checked) {
            overlayBytes = await fetchArrayBuffer(OPTION3_URL);
          } else if (preset4Radio.checked) {
            overlayBytes = await fetchArrayBuffer(OPTION4_URL);
          } else if (preset5Radio.checked) {
            overlayBytes = await fetchArrayBuffer(OPTION5_URL);
          } else if (customRadio.checked) {
            const file = fileInput.files[0];
            if (!file) {
              alert('Please choose a file to upload.');
              return;
            }
            overlayBytes = await file.arrayBuffer();
          } else {
            alert('Please select one of the options or upload your own image.');
            return;
          }
        } catch (err) {
          console.error(err);
          alert('Error fetching or reading the selected image.');
          return;
        }

        // Fetch and embed the template PNG
        let templateBytes;
        try {
          templateBytes = await fetchArrayBuffer(TEMPLATE_URL);
        } catch (err) {
          console.error(err);
          alert('Error fetching the template image.');
          return;
        }

        const pdfDoc = await PDFDocument.create();
        let templateImage;
        try {
          templateImage = await pdfDoc.embedPng(templateBytes);
        } catch (embedErr) {
          console.error(embedErr);
          alert('Failed to embed template PNG.');
          return;
        }

        const templateDims = templateImage.scale(1);
        const pageWidth  = templateDims.width;
        const pageHeight = templateDims.height;
        const page = pdfDoc.addPage([pageWidth, pageHeight]);

        page.drawImage(templateImage, {
          x: 0,
          y: 0,
          width: pageWidth,
          height: pageHeight
        });

        let overlayImage;
        try {
          const header = new Uint8Array(overlayBytes).subarray(0, 4);
          const isPng = header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4E && header[3] === 0x47;
          if (isPng) {
            overlayImage = await pdfDoc.embedPng(overlayBytes);
          } else {
            overlayImage = await pdfDoc.embedJpg(overlayBytes);
          }
        } catch (embedErr) {
          console.error(embedErr);
          alert('Failed to embed the chosen image.');
          return;
        }

        const bottom = 952;
        const top = 638;
        const maxHeight = bottom - top;
        const imageDims = await getImageDimensionsFromBytes(overlayBytes);

        let scale = 1;
        if (imageDims.height > maxHeight) {
          scale = maxHeight / imageDims.height;
        }
        const drawWidth = imageDims.width * scale;
        const drawHeight = imageDims.height * scale;
        const pdfX = (pageWidth - drawWidth) / 2;
        const pdfY = templateDims.height - bottom;

        page.drawImage(overlayImage, {
          x: pdfX,
          y: pdfY,
          width: drawWidth,
          height: drawHeight
        });

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'custom_attendance_graphic.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    })();
  </script>
</body>
</html>
