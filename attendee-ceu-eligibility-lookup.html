<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Attendee CEU Eligibility Lookup</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--primary-blue:#162A53;--primary-green:#89A84F;--white:#FFFFFF;--input-border:#d1d9e6;--shadow-light:rgba(22,42,83,.08)}
  html,body,input,button,label,h2{font-family:'Montserrat',sans-serif!important}
  body{background-color:var(--white)}
  .card-like{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  .action-btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;background:var(--primary-blue);color:#fff;border:none;border-radius:10px;padding:.75rem 1rem;font-weight:600;box-shadow:0 6px 12px var(--shadow-light);transition:transform .15s,box-shadow .15s}
  .action-btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px var(--shadow-light)}
  .action-btn:active{transform:translateY(0);box-shadow:0 4px 8px var(--shadow-light)}
</style>
</head>
<body>
  <div class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- Banner -->
    <img 
      src="https://custom.cvent.com/AE944F71438646268B70FF5BF3772347/files/event/6e39e63ddecc460ba1e0481e3ecf2d04/6bf4acb9458c4216bb19bd6432e3f524.png" 
      alt="Conference Banner" 
      class="mb-6 w-full rounded-lg shadow"
    />
    
    <section class="card-like p-6">
<h2 class="text-2xl font-bold text-[var(--primary-blue)] mb-4">
  CEU Eligibility Lookup
</h2>

<p class="text-sm text-gray-700 mb-6">
  Enter in your email below to see if you are eligible to claim CEUs at this event.
</p>

      <form id="lookup-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
        <div class="sm:col-span-2">
          <label for="email" class="block text-sm font-medium text-gray-700">Registration email</label>
          <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="e.g., name@example.com"
            class="mt-1 w-full border-2 border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-[var(--primary-green)] focus:ring-0"/>
        </div>
        <div class="flex gap-2">
          <button id="search" type="submit" class="action-btn w-full">Search</button>
          <button id="clear" type="button" class="px-4 py-2 border-2 border-gray-200 rounded-lg">Clear</button>
        </div>
      </form>

      <div id="results-wrap" class="mt-6 hidden">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="text-left py-2 pr-4 font-semibold">Name</th>
              <th class="text-left py-2 pr-4 font-semibold">Email</th>
              <th class="text-left py-2 pr-4 font-semibold">Eligible to claim CEUs</th>
            </tr>
          </thead>
          <tbody id="results-body"></tbody>
        </table>
        <p id="status" class="mt-3 text-sm text-gray-500"></p>
      </div>

      <p id="empty" class="mt-4 text-sm text-gray-500"></p>
    </section>
  </div>
<script>
let SESSIONS_AS_OF;
let PBKDF2_ITERATIONS;
let ATTENDEE_INDEX = [];

async function loadRemoteConfig() {
const URL = "https://gist.githubusercontent.com/jqman23/44c238296696cae50ebb7d12bc9f3a63/raw/attendee-index.json";

  const res = await fetch(URL + "?v=" + Date.now(), { cache: "no-store" });
  if (!res.ok) throw new Error("Failed to fetch remote config (HTTP " + res.status + ")");
  const data = await res.json();
  if (!data.SESSIONS_AS_OF || !data.PBKDF2_ITERATIONS || !Array.isArray(data.ATTENDEE_INDEX)) {
    throw new Error("Remote config missing required fields");
  }
  SESSIONS_AS_OF = data.SESSIONS_AS_OF;
  PBKDF2_ITERATIONS = data.PBKDF2_ITERATIONS;
  ATTENDEE_INDEX = data.ATTENDEE_INDEX;
  console.log("Loaded remote config:", { SESSIONS_AS_OF, PBKDF2_ITERATIONS, count: ATTENDEE_INDEX.length });
}

const enc = new TextEncoder();
function normalizeEmail(s){ return (s||"").trim().toLowerCase(); }
function b64ToBytes(b64){ return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }
function bytesToB64(bytes){ return btoa(String.fromCharCode(...new Uint8Array(bytes))); }
async function deriveHashB64(email, saltB64, iterations=PBKDF2_ITERATIONS){
  const key = await crypto.subtle.importKey("raw", enc.encode(email), { name: "PBKDF2" }, false, ["deriveBits"]);
  const bits = await crypto.subtle.deriveBits(
    { name: "PBKDF2", hash: "SHA-256", salt: b64ToBytes(saltB64), iterations },
    key, 256
  );
  return bytesToB64(new Uint8Array(bits));
}

async function init() {
  try {
    await loadRemoteConfig();
  } catch (err) {
    alert("Failed to load eligibility data. Please try again later.");
    console.error(err);
    return;
  }

  const form = document.getElementById('lookup-form');
  const emailEl = document.getElementById('email');
  const resultsWrap = document.getElementById('results-wrap');
  const resultsBody = document.getElementById('results-body');
  const statusEl = document.getElementById('status');
  const emptyEl = document.getElementById('empty');
  const clearBtn = document.getElementById('clear');

  function renderNone(msg){
    resultsWrap.classList.add('hidden');
    resultsBody.innerHTML = '';
    statusEl.textContent = '';
    emptyEl.textContent = msg || 'No match found.';
  }

  function renderRow(name, email, ceu){
    resultsBody.innerHTML = `
      <tr class="border-b">
        <td class="py-2 pr-4">${name || ''}</td>
        <td class="py-2 pr-4">${email}</td>
        <td class="py-2 pr-4">${ceu}</td>
      </tr>`;
    resultsWrap.classList.remove('hidden');
    emptyEl.textContent = '';
    statusEl.innerHTML = `1 match â€¢ Eligibility data as of <span class="text-[var(--primary-blue)] font-semibold">${SESSIONS_AS_OF}</span>.`;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = normalizeEmail(emailEl.value);
    if (!q){ renderNone("Please enter your registration email."); return; }

    let found = null;
    for (const rec of ATTENDEE_INDEX){
      const h = await deriveHashB64(q, rec.salt);
      if (h.length === rec.hash.length){
        let mismatch = 0;
        for (let i=0;i<h.length;i++){ mismatch |= (h.charCodeAt(i) ^ rec.hash.charCodeAt(i)); }
        if (mismatch === 0){ found = rec; break; }
      } else if (h === rec.hash){ found = rec; break; }
    }

    if (found){
      renderRow(found.name || "(Name hidden)", q, found.ceu || "Unknown");
    } else {
      renderNone("We could not find a registration under that email. Double check spelling or contact ctaconference@cuanschutz.edu.");
    }
  });

  clearBtn.addEventListener('click', () => {
    emailEl.value = '';
    renderNone('');
    emailEl.focus();
  });
}

init();
</script>

</body>
</html>
