<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CEU Eligibility Generator</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f6f7fb;margin:0}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:20px}
    h1{font-size:20px;margin:0 0 12px}
    label{font-weight:600;font-size:13px}
    input[type="file"]{padding:8px;border:1px solid #ddd;border-radius:8px}
    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{padding:9px 12px;border-radius:8px;border:1px solid #ddd;cursor:pointer}
    .btn.primary{background:#1f6feb;color:#fff;border-color:#1f6feb}
    textarea{width:100%;height:440px;margin-top:10px;font-family:monospace;white-space:pre;border:1px solid #ddd;border-radius:8px;padding:10px}
    .errors{white-space:pre-wrap;color:#b91c1c;font-weight:600;margin-top:8px}
    .indicator{font-size:12px;color:green;opacity:0;transition:opacity .15s}
    .indicator.show{opacity:1}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>CEU Eligibility Generator</h1>

    <label>Registration CSV</label><br>
    <input id="regFile" type="file" accept=".csv">

    <div class="controls">
      <button id="processBtn" class="btn primary">Generate JSON</button>
      <button id="publishBtn" class="btn">Publish to GitHub</button>
      <span id="publishInd" class="indicator">Published!</span>
    </div>

    <textarea id="out" readonly></textarea>
    <div id="errs" class="errors"></div>
  </div>
</div>

<script>
/* ---------- CSV helpers ---------- */
function parseCSVLine(line){
  const out=[];let cur='',inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){
      if(inQ && i+1<line.length && line[i+1]==='"'){cur+='"';i++;}
      else{inQ=!inQ;}
    } else if(ch===',' && !inQ){ out.push(cur); cur=''; }
    else cur+=ch;
  }
  out.push(cur); return out;
}
function splitIntoLogicalRows(text){
  const phys=String(text).split(/\r\n|\n/),rows=[];let buf='',q=0;
  for(const line of phys){
    if(buf===''){buf=line;q=(line.match(/"/g)||[]).length;}
    else{buf+='\n'+line;q+=(line.match(/"/g)||[]).length;}
    if(q%2===0){rows.push(buf);buf='';q=0;}
  }
  if(buf.trim()!=='')rows.push(buf);
  return rows.filter(r=>r.trim()!=='');
}
function cleanCell(v){
  if(v===undefined||v===null) return '';
  v=String(v).trim();
  if(v.startsWith('"') && v.endsWith('"') && v.length>=2) v=v.slice(1,-1).replace(/""/g,'"');
  return v;
}
function normalizeHeader(h){
  return String(h||'').replace(/^\uFEFF/, '').toLowerCase().trim();
}

/* ---------- Denver timestamp ---------- */
function getDenverAsOf(){
  const fmt = new Intl.DateTimeFormat('en-US', {
    timeZone: 'America/Denver',
    month: 'long', day: 'numeric', year: 'numeric',
    hour: 'numeric', minute: '2-digit', hour12: true, timeZoneName: 'short'
  });
  return fmt.format(new Date());
}

/* ---------- Crypto helpers ---------- */
const DEFAULT_ITER = 30000;
const enc = new TextEncoder();
function bytesToB64(b){return btoa(String.fromCharCode(...new Uint8Array(b)));}
function b64ToBytes(b64){return Uint8Array.from(atob(b64), c=>c.charCodeAt(0));}
function normEmail(s){return (s||"").trim().toLowerCase();}
function randSaltB64(len=16){const a=new Uint8Array(len);crypto.getRandomValues(a);return bytesToB64(a);}
async function deriveHashB64(email, saltB64, iterations=DEFAULT_ITER){
  const key = await crypto.subtle.importKey("raw", enc.encode(email), {name:"PBKDF2"}, false, ["deriveBits"]);
  const bits = await crypto.subtle.deriveBits({name:"PBKDF2", hash:"SHA-256", salt:b64ToBytes(saltB64), iterations}, key, 256);
  return bytesToB64(new Uint8Array(bits));
}

/* ---------- UI refs ---------- */
const $reg=document.getElementById('regFile');
const $out=document.getElementById('out');
const $errs=document.getElementById('errs');
const $publishInd=document.getElementById('publishInd');
let lastOutputJSON=null;

/* ---------- File util ---------- */
function readFileAsText(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=e=>resolve(e.target.result);
    fr.onerror=e=>reject(e);
    fr.readAsText(file);
  });
}

/* ---------- MAIN ---------- */
document.getElementById('processBtn').addEventListener('click', async ()=>{
  $out.value=''; $errs.textContent=''; lastOutputJSON=null;
  try{
    if(!$reg.files.length){
      $errs.textContent='ERROR: Select Registration CSV (required).'; return;
    }

    const regText = await readFileAsText($reg.files[0]);
    const regRows = splitIntoLogicalRows(regText);
    if(regRows.length<2){$errs.textContent='ERROR: Registration CSV has no data rows.'; return;}

    const regHeaders = parseCSVLine(regRows[0]).map(h=>h.trim());
    const regNorm = regHeaders.map(normalizeHeader);
    const emailIdx = regNorm.indexOf('email address');
    const firstIdx = regNorm.indexOf('first name');
    const lastIdx  = regNorm.indexOf('last name');
    const typeIdx  = regNorm.indexOf('registration type');
    if(emailIdx===-1||firstIdx===-1||lastIdx===-1||typeIdx===-1){
      $errs.textContent='ERROR: Missing one of required columns (Email Address, First Name, Last Name, Registration Type).';
      return;
    }

    const attendeesRaw=[];
    regRows.slice(1).forEach(row=>{
      const f=parseCSVLine(row);
      const email=cleanCell(f[emailIdx]);
      const first=cleanCell(f[firstIdx]);
      const last=cleanCell(f[lastIdx]);
      const regType=cleanCell(f[typeIdx]);
      const ceu=/ceu/i.test(regType)?'Yes':'No';
      if(email) attendeesRaw.push({name:`${first} ${last}`.trim(), email:normEmail(email), ceu});
    });

    const hashed=[];
    for(const r of attendeesRaw){
      const salt=randSaltB64();
      const hash=await deriveHashB64(r.email,salt,DEFAULT_ITER);
      hashed.push({name:r.name, salt, hash, ceu:r.ceu});
    }

    const outJSON={
      SESSIONS_AS_OF:getDenverAsOf(),
      PBKDF2_ITERATIONS:DEFAULT_ITER,
      ATTENDEE_INDEX:hashed
    };
    lastOutputJSON=outJSON;
    $out.value=JSON.stringify(outJSON,null,2);
  }catch(err){
    $errs.textContent='ERROR: '+err.message;
  }
});

/* ---------- Publish to GitHub via Vercel API ---------- */
document.getElementById('publishBtn').addEventListener('click', async ()=>{
  if(!lastOutputJSON){$errs.textContent='Generate JSON first.';return;}
  try{
    const res=await fetch('/api/update-gist',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(lastOutputJSON)
    });
    const result=await res.json();
    if(res.ok){
      $publishInd.classList.add('show');
      setTimeout(()=> $publishInd.classList.remove('show'),1000);
    }else{
      $errs.textContent='Publish failed: '+(result.message||'Unknown error');
    }
  }catch(err){
    $errs.textContent='Publish error: '+err.message;
  }
});
</script>
</body>
</html>
